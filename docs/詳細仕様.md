# 詳細仕様（プロトタイプ / GitHub Pages運用）

本ドキュメントは、リポジトリに含まれる静的Webアプリ（`index.html`）の挙動・入出力・前提を「実装に沿って」整理した詳細仕様です。

---

## 1. 目的

- 行政事業レビュー（RSシステム）のCSV（特に **2-2「予算種別・歳出予算項目」**）を、ブラウザ上で手軽に可視化する。
- GitHub Pagesで公開できる **静的Webアプリ** とし、利用者はCSVを手動アップロードして閲覧する。

---

## 2. 対象データ（入力）

### 2.1 必須入力

- RSシステムのCSV（2-2）
  - ダウンロード: `https://rssystem.go.jp/download-csv`
  - 本アプリはCSVを同梱しない（`データ/` は `.gitignore` 対象）。

### 2.2 使用する主な列（2-2）

実装で参照する代表的な列:
- `事業名`
- `府省庁`
- `予算年度`
- `会計区分`（`一般会計` / `特別会計`）
- `予算額（歳出予算項目ごと）`（円）

注:
- 列名はCSVのヘッダ文字列に依存します（ヘッダ表記の変更があると読み取りに失敗します）。

---

## 3. 出力（表示）

### 3.1 年度別の積み上げ棒（メイン）

- 横軸: `予算年度`
- 縦軸: `予算額（歳出予算項目ごと）` の合算（円）
- スタック: 選択した分類（プリセット/JSON/省庁別）によるカテゴリ
- フィルタ:
  - `府省庁`（全府省庁/指定）
  - `会計区分`（一般会計/特別会計/両方）
- 操作:
  - 凡例はチェックボックス形式（カテゴリごとに表示/非表示）
  - セグメントにホバーすると「年度 / カテゴリ / 金額」を表示

### 3.2 カテゴリ別 上位事業（トップN）

- 対象: 2-2の行を `事業名` 単位で合算し、金額上位を表示
- フィルタ:
  - `カテゴリ`（個別カテゴリ / `（全て）`）
  - `年度`（最新年度がデフォルト / `（全て）`）
  - `府省庁`
  - `会計区分`
  - `上位表示数`（N）

---

## 4. 分類（カテゴリ付与）仕様

### 4.1 分類モード

分類は以下のモードで動作します。

1) **プリセットJSON / アップロードJSON / 生成JSON（AI）**
- JSON（`事業名 -> カテゴリ`）を **権威（authoritative）** として扱う。
- JSONに存在しない `事業名` は **無視**（集計対象に含めない）。
  - 目的: 年度や更新で事業名が揺れた際に、誤ったカテゴリへフォールバック分類されることを避ける。

2) **分類JSONなし（簡易ルール）**
- `事業名` をキーワードで簡易分類する（あくまで暫定）。
- この場合は分類不能なものは `その他` へ入る。

3) **省庁別（JSON不要）**
- カテゴリ = `府省庁`（CSV列をそのまま利用）

### 4.2 分類JSONの形式

JSONは次の形式のオブジェクト:

```json
{
  "基礎年金給付に必要な経費": "年金",
  "高校生等への修学支援": "子ども・子育て"
}
```

備考:
- キーは `事業名` の完全一致を前提（部分一致や正規化は未実装）。

### 4.3 プリセットJSONの配置

- `JSON/` フォルダに格納する。
- 画面上の「分類プリセット」から読み込み（`fetch`）して使用する。

---

## 5. AIで分類JSONを生成（ブラウザ実行）

### 5.1 目的

- 任意のカテゴリ体系（利用者定義）に基づいて、事業名のカテゴリ付与JSONを生成する。

### 5.2 入力

- プロバイダ: OpenAI / Google Gemini
- モデル名（テキスト入力）
- APIキー
- 分割サイズ（chunk size）
- カテゴリ一覧（1行=1カテゴリ、任意で説明付き）

### 5.3 出力

- 生成結果をアプリへ適用（その場で可視化に使用）
- JSONとしてダウンロード（`ai_classification_map_custom.json`）

### 5.4 進捗/エラー表示

- 進捗ステータス（完了チャンク数/総チャンク数、経過時間）
- 詳細ログ（チャンク送信/完了/処理時間/HTTPエラー本文抜粋）
- 中断ボタン（AbortController）

### 5.5 注意（重要）

- 静的サイトでAPIキーを入力すると、キーがブラウザ上で扱われます。
  - 画面共有/拡張機能/ログ/端末環境によっては漏洩リスクがあります。
- ネットワーク要因（CORS、レート制限、課金、プロバイダ側障害等）で失敗する可能性があります。
- 分類は事業名などのテキストから推測して行うため、不正確な場合があります（元データ確認が必要）。

---

## 6. データの留意点（公式）

- データの性質・制約・丸め・移行データ差異などは公式の留意事項に従う:
  - `https://rssystem.go.jp/notice`

---

## 7. 公開（GitHub Pages）

- `index.html` をルートに配置し、GitHub Pagesで公開できる構成とする。
- データ（CSV）は利用者が都度アップロードするため、リポジトリには含めない。

---

## 8. 既知の制約 / 仕様上の割り切り

- JSON分類は `事業名` の完全一致依存（表記ゆれ対応は未実装）。
- JSONがある場合、未分類事業は「その他に落とさず除外」する（誤分類回避のため）。
- CSVヘッダ名が変更されると読み取りに失敗する可能性がある。
- 大規模CSVや大きいchunk sizeは、ブラウザ性能やAPIレート制限により時間がかかる可能性がある。

---

## 9. 今後の拡張候補

- 事業名の正規化（全角半角/空白/括弧/表記ゆれ）や部分一致、別ID列での突合
- 未分類の可視化（「未分類一覧」「未分類だけをAIに再問い合わせ」）
- 2-1（予算・執行サマリ）等のCSVも含めた整合チェック
- 生成結果のレビューUI（手修正、差分、バージョン管理）

